<!DOCTYPE html>
<html lang="zh" οndragstart="return false;">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服务器消息架构</title>
    <link rel="stylesheet" href="../index.css" cache="force">
</head>

<body οndragstart="return false;">
    <div style="position: fixed; left: 0; top: 0; width: 100%; height: 100%; padding: 0;">
        <div class="left-container">
            <div class="header-container">
                <a href="https://github.com/xminnn"><img src="../icon.jpg" cache="force"></a>
            </div>
            <div id="dir-container">
                <div class="node-dir">
<div class="node-dir-name">c++</div>
<div class="node-children">
<div class="node-item">
<div id="article-7" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./7.html">c++基础总结</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040871" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040871.html">代码静态检测工具</a>
</div>
</div>
<div class="node-item">
<div id="article-1" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1.html">共享内存</a>
</div>
</div>
<div class="node-item">
<div id="article-2" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./2.html">开源项目</a>
</div>
</div>
<div class="node-item">
<div id="article-3" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./3.html">开源游戏引擎以及工具</a>
</div>
</div>
<div class="node-item">
<div id="article-4" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./4.html">性能分析</a>
</div>
</div>
<div class="node-item">
<div id="article-8" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./8.html">c++模板的偏特化与全特化</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040863" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040863.html">c++模板元编程</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040864" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040864.html">c++虚表的内存结构</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040862" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040862.html">c++右值引用</a>
</div>
</div>
<div class="node-item">
<div id="article-5" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./5.html">fopen</a>
</div>
</div>
<div class="node-item">
<div id="article-6" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./6.html">icmp实现ping</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078880027" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078880027.html">Makefile</a>
</div>
</div>
<div class="node-item">
<div id="article-9" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./9.html">mmap</a>
</div>
</div>
<div class="node-item">
<div id="article-1745082315831" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745082315831.html">socket配置</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">游戏后端</div>
<div class="node-children">
<div class="node-item">
<div id="article-1745504985606" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745504985606.html">服务器消息架构</a>
</div>
</div>
<div class="node-item">
<div id="article-1745504985608" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745504985608.html">道具系统</a>
</div>
</div>
<div class="node-item">
<div id="article-1745504985607" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745504985607.html">条件系统</a>
</div>
</div>
<div class="node-item">
<div id="article-1745082315832" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745082315832.html">好文推荐</a>
</div>
</div>
<div class="node-item">
<div id="article-1745765918114" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745765918114.html">导表设计</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">服务</div>
<div class="node-children">
<div class="node-item">
<div id="article-27" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./27.html">elasticsearch</a>
</div>
</div>
<div class="node-item">
<div id="article-26" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./26.html">kafka</a>
</div>
</div>
<div class="node-item">
<div id="article-25" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./25.html">mongo</a>
</div>
</div>
<div class="node-item">
<div id="article-24" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./24.html">mysql</a>
</div>
</div>
<div class="node-item">
<div id="article-23" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./23.html">redis</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">算法</div>
<div class="node-children">
<div class="node-item">
<div id="article-30" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./30.html">查找算法</a>
</div>
</div>
<div class="node-item">
<div id="article-35" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./35.html">调度算法</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040877" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040877.html">动态规划</a>
</div>
</div>
<div class="node-item">
<div id="article-42" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./42.html">二叉树</a>
</div>
</div>
<div class="node-item">
<div id="article-34" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./34.html">缓存淘汰算法</a>
</div>
</div>
<div class="node-item">
<div id="article-36" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./36.html">加密算法</a>
</div>
</div>
<div class="node-item">
<div id="article-45" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./45.html">链表</a>
</div>
</div>
<div class="node-item">
<div id="article-31" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./31.html">排序算法</a>
</div>
</div>
<div class="node-item">
<div id="article-44" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./44.html">其他常见算法题</a>
</div>
</div>
<div class="node-item">
<div id="article-33" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./33.html">时间轮</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040879" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040879.html">算法思想</a>
</div>
</div>
<div class="node-item">
<div id="article-32" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./32.html">跳表</a>
</div>
</div>
<div class="node-item">
<div id="article-37" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./37.html">寻路算法</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040878" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040878.html">游戏开发中的噪声算法</a>
</div>
</div>
<div class="node-item">
<div id="article-43" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./43.html">栈和队列</a>
</div>
</div>
<div class="node-item">
<div id="article-38" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./38.html">正太分布随机数算法</a>
</div>
</div>
<div class="node-item">
<div id="article-39" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./39.html">huffman压缩算法</a>
</div>
</div>
<div class="node-item">
<div id="article-40" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./40.html">lz77压缩算法</a>
</div>
</div>
<div class="node-item">
<div id="article-41" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./41.html">md5算法</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">linux</div>
<div class="node-children">
<div class="node-item">
<div id="article-11" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./11.html">常见问题</a>
</div>
</div>
<div class="node-item">
<div id="article-12" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./12.html">常用命令</a>
</div>
</div>
<div class="node-item">
<div id="article-13" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./13.html">代理</a>
</div>
</div>
<div class="node-item">
<div id="article-21" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./21.html">镜像源</a>
</div>
</div>
<div class="node-item">
<div id="article-20" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./20.html">配置网络</a>
</div>
</div>
<div class="node-item">
<div id="article-22" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./22.html">设置core文件</a>
</div>
</div>
<div class="node-item">
<div id="article-14" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./14.html">用户与权限</a>
</div>
</div>
<div class="node-item">
<div id="article-15" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./15.html">dns修改</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040872" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040872.html">proot</a>
</div>
</div>
<div class="node-item">
<div id="article-16" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./16.html">qemu</a>
</div>
</div>
<div class="node-item">
<div id="article-17" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./17.html">ssh穿透</a>
</div>
</div>
<div class="node-item">
<div id="article-18" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./18.html">surfacebook2安装archlinux记录</a>
</div>
</div>
<div class="node-item">
<div id="article-19" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./19.html">systemctl守护自定义程序</a>
</div>
</div>
<div class="node-item">
<div id="article-1745505189602" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745505189602.html">tcp抓包</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">工具</div>
<div class="node-children">
<div class="node-item">
<div id="article-51" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./51.html">软媒工具组件精选</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040876" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040876.html">网址大全</a>
</div>
</div>
<div class="node-item">
<div id="article-49" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./49.html">ai对话</a>
</div>
</div>
<div class="node-item">
<div id="article-50" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./50.html">ai绘画</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040874" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040874.html">blender</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040875" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040875.html">docker</a>
</div>
</div>
<div class="node-item">
<div id="article-47" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./47.html">git</a>
</div>
</div>
<div class="node-item">
<div id="article-48" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./48.html">svn</a>
</div>
</div>
<div class="node-item">
<div id="article-53" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./53.html">vim</a>
</div>
</div>
<div class="node-item">
<div id="article-46" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./46.html">vscode</a>
</div>
</div>
<div class="node-item">
<div id="article-52" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./52.html">winfsp</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">其他</div>
<div class="node-children">
<div class="node-item">
<div id="article-56" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./56.html">开源协议</a>
</div>
</div>
<div class="node-item">
<div id="article-57" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./57.html">终端输出特殊代码</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040873" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040873.html">Android开发环境快速搭建</a>
</div>
</div>
<div class="node-item">
<div id="article-1745506516212" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745506516212.html">opengl积雪效果</a>
</div>
</div>
<div class="node-item">
<div id="article-55" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./55.html">python简单日志工具</a>
</div>
</div>
<div class="node-item">
<div id="article-58" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./58.html">windows相关</a>
</div>
</div>
</div>
</div>

            </div>
        </div>
        <div class="right-container">
            <div id="md-container">
                <div class="title"> 服务器消息架构 </div>
                <div class="info">
                    <div class="create_time">创建:2025-04-24 22:26</div>
                    <div class="update_time">更新:2025-04-24 23:29</div>
                </div>
                <div class="line"></div>

                <div id="md-container-content" style="position: relative;"><h3 id=""># 游戏服务器消息架构设计核心目标</h3>
<p>消息通讯是游戏服务器架构的核心命脉，需在可靠性、性能与可维护性间取得平衡。本架构设计围绕以下关键目标展开：  </p>
<ol>
<li>消息零丢失保障<ul>
<li>故障恢复机制：支持服务自动拉起、热更重启、手动维护及动态扩容场景下的消息持久化。  </li>
<li>状态一致性：确保有状态服务在异常中断时，内存中的未处理消息可完整恢复。  </li></ul></li>
<li>连接管理优化  <ul>
<li>避免NxN连接风暴：通过中心化路由层（如Linker服务）收敛连接，降低维护复杂度。  </li></ul></li>
<li>弹性伸缩能力  <ul>
<li>动态扩缩容：支持服务实例的秒级扩容与缩容，流量自动重平衡。  </li></ul></li>
<li>高性能传输 <ul>
<li>低延迟：端到端通信延迟控制在毫秒级，满足游戏实时性需求。  </li>
<li>高吞吐：单节点百万级消息/秒处理能力，横向扩展无瓶颈。  </li></ul></li>
<li>开发友好性  <ul>
<li>透明化接入：提供简洁的SDK接口，屏蔽底层通讯细节。  </li>
<li>全链路追踪：内置消息染色与日志追踪，快速定位问题链路。  </li></ul></li>
</ol>
<p>这里讨论的是业务服务器的架构。对于房间战斗类服务，可以直连到对应的服务器以获得更低延迟。</p>
<h3 id="-1"># 持久化消息通讯方案对比与选型</h3>
<p>游戏服务器需同时满足有状态服务高频重启与高并发低延迟的双重挑战。传统RPC框架（gRPC/SRPC）在服务宕机时易丢失内存中的未处理消息，想要解决问题1和问题2，则必然需要引入消息队列。 主流消息队列（Kafka/RabbitMQ/RocketMQ）如下：  </p>
<table>
<thead>
<tr>
<th>消息队列</th>
<th>吞吐量</th>
<th>消息删除机制</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kafka</td>
<td>高（百万级）</td>
<td>按时间/大小保留</td>
<td>大数据管道、日志流</td>
</tr>
<tr>
<td>RabbitMQ</td>
<td>中（十万级）</td>
<td>ACK后删除</td>
<td>企业级异步任务</td>
</tr>
<tr>
<td>RocketMQ</td>
<td>高（百万级）</td>
<td>消费进度控制</td>
<td>金融级事务消息</td>
</tr>
<tr>
<td>NATS</td>
<td>极高</td>
<td>WorkQueue模式</td>
<td>实时消息分发</td>
</tr>
</tbody>
</table>
<p>其中kafka, rabbitmq, rocketmq等mq要么因为性能不足，要么无法立即删除已经消费的消息浪费存储。因此并不适合作为游戏后端的消息通讯组件。此处仅探讨一下nats。</p>
<h4 id="natsjetstream">NATS JetStream性能验证</h4>
<p>通过Go语言测试NATS JetStream在WorkQueue模式下的吞吐能力：  </p>
<pre><code class="go language-go">package main

import (
    "log"
    "time"

    "github.com/nats-io/nats.go"
)

func main() {
    nc, _ := nats.Connect("nats://localhost:4222")
    js, _ := nc.JetStream(nats.PublishAsyncMaxPending(1000)) // 控制并发量

    // 创建流（主题为test.&gt;，内存存储）
    js.AddStream(&amp;nats.StreamConfig{
        Name:      "perf-test",
        Subjects:  []string{"test.&gt;"},
        Storage:   nats.FileStorage,     // 或nats.FileStorage
        Retention: nats.WorkQueuePolicy, // 关键：工作队列模式
        MaxMsgs:   -1,                   // 无数量限制
        MaxBytes:  -1,                   // 无存储限制
        MaxAge:    0,                    // 0 表示永不过期（对应 CLI 的 -1）
        Discard:   nats.DiscardOld,      // 旧消息丢弃策略
    })

    // 异步发送（每秒10万条）
    start := time.Now()
    for i := 0; i &lt; 1000000; i++ {
        _, err := js.PublishAsync("test.data", []byte("curl -L https://go.dl/go1.23.4.linux-arm64.tar.gz -O go1.23.4.linux-arm64.tar.gz4.linux-arm64.tar.gz"))
        if err != nil {
            log.Fatal("发布失败:", err)
        }
    }

    // 等待所有ACK确认
    select {
    case &lt;-js.PublishAsyncComplete():
        log.Printf("吞吐量: %.0f msg/s", 1000000/time.Since(start).Seconds())
    case &lt;-time.After(5 * time.Second):
        log.Fatal("超时未完成")
    }
}

/*
# 启动nats-server
下载 https://github.com/nats-io/nats-server/releases/tag/v2.11.1
启动 ./nats-server -js -sd $(pwd)/data
*/
</code></pre>
<p>压测结果（5次连续测试）:  </p>
<table>
<thead>
<tr>
<th>测试轮次</th>
<th>吞吐量（msg/s）</th>
<th>网络带宽占用</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>179,732</td>
<td>~17.1 MB/s</td>
</tr>
<tr>
<td>2</td>
<td>178,877</td>
<td>~17.0 MB/s</td>
</tr>
<tr>
<td>3</td>
<td>185,031</td>
<td>~17.6 MB/s</td>
</tr>
<tr>
<td>4</td>
<td>170,683</td>
<td>~16.3 MB/s</td>
</tr>
<tr>
<td>5</td>
<td>167,066</td>
<td>~15.9 MB/s</td>
</tr>
</tbody>
</table>
<p>NATS JetStream在内存模式下可实现17万+/秒的稳定吞吐，满足多数游戏场景需求，但其中心化路由机制仍可能引入额外延迟。  </p>
<p>使用nats作为通讯组件，则架构如下</p>
<pre><code>客户端 ↔ Linker服务(tcp服务器) ↔ [ NATS JetStream ] ↔ Game服务/其他服务  
</code></pre>
<h4 id="hrpcudp">自主协议优化：HRPC（基于UDP协议实现高性能可靠持久化消息协议）</h4>
<p>为消除消息队列的中间层开销，我实现了一个基于UDP实现端到端可靠传输协议<a href="https://github.com/xminnn/hrpc">【hrpc】</a>。</p>
<p>核心优势：  </p>
<ul>
<li>减少路由拷贝：通过Linker服务直连目标节点，减少一次数据拷贝与路由查询。  </li>
<li>消息持久化：基于mmap内存映射的方式，确保程序崩溃或者热更重启是消息不丢失。且能够写入磁盘，方便节点迁移扩容配置也不丢失消息。  </li>
</ul>
<p>性能压测数据 </p>
<table>
<thead>
<tr>
<th>消息大小</th>
<th>吞吐量（msg/s）</th>
<th>网络带宽占用</th>
</tr>
</thead>
<tbody>
<tr>
<td>100字节</td>
<td>304,895</td>
<td>~29.7 MB/s</td>
</tr>
<tr>
<td>1000字节</td>
<td>295,602</td>
<td>~288.6 MB/s</td>
</tr>
</tbody>
</table>
<p>基于hrpc的服务器架构则可以修改成:</p>
<pre><code>客户端 ↔ Linker服务(tcp和hrpc服务器) ↔ Game服务/其他服务  
</code></pre>
<p>优势对比:  </p>
<ul>
<li>延迟降低40%：端到端直连减少路由跳数。  </li>
<li>吞吐提升70%：hrpc本身优秀的吞吐量 </li>
</ul>
<h3 id="-2">应用层协议头设计</h3>
<p>上边是决定底层通讯协议， 接下来需要处理应用层之间的数据交互。以下是一个简单消息头参考，包含了消息传递过程中的必要信息。</p>
<pre><code class="c language-c">struct msg_head { // 40byte
    int flag; // 识别flag. 不同的版本可以用不同的识别标志例如 v1.1
    int func;  // 请求的函数
    unsigned long long gseq; // 全局唯一标识，用于日志染色
    unsigned long long key; // 目标服务状态key，例如uid, sid, aid(联盟id)
    int req_size; // 请求包大小
    int ctx_size; // 携带的context大小
    int to_nid; // 目标nid
    char from_type; // 来源: service, player, platform
    char compressed; // 是否压缩
    short check; // 包校验
};
</code></pre>
<h3 id="-3">消息序列化设计</h3>
<p>常见的消息序列化方式有json, protobuf或者直接传输bin数据(直接传递结构体示例数据)。json可以更好的阅读，但是性能差于protobuff, protobuff序列化结果更小。在我经历的项目中，大多数会选择protobuf作为序列化方式。</p>
<p>以下是各个方式的优劣对比：</p>
<table>
<thead>
<tr>
<th></th>
<th>protobuf</th>
<th>json</th>
<th>bin</th>
</tr>
</thead>
<tbody>
<tr>
<td>优点</td>
<td>1.速度快<br>2.体积小</td>
<td>1.可视化<br>2.游戏使用脚本修复数据容易<br>3.使用简单</td>
<td>1.序列化反序列化快</td>
</tr>
<tr>
<td>缺点</td>
<td>1.需要额外的proto文件,增加维护复杂度</td>
<td>1.序列化反序列化稍慢</td>
<td>1. 对动态数组不友好</td>
</tr>
</tbody>
</table>
<p>我在自己的框架中选用json来做消息序列化对象。使用<a href="https://github.com/xminnn/jsonc">【jsonc】</a> 根据定义的结构体直接生成json序列化反序列化。性能高，可视化好。特别是对使用共享内存或者mmap的 GameUser 来说，能够非常简单地完成序列化和反序列化，而protobuf还需要额外一一取值赋值一遍。</p>
<p>【jsonc】反序列化146kb大小的json数据性能如下:</p>
<table>
<thead>
<tr>
<th></th>
<th>jsonc</th>
<th>yyjson</th>
</tr>
</thead>
<tbody>
<tr>
<td>-O0</td>
<td>525us</td>
<td>418us</td>
</tr>
<tr>
<td>-O3</td>
<td>168us</td>
<td>141us</td>
</tr>
</tbody>
</table></div>
            </div>
        </div>
    </div>

    <script>
        let scrollTop = window.localStorage.getItem('scrollTop');
        let container = document.getElementById("dir-container");
        if (scrollTop) {
            container.scrollTop = scrollTop;
        } else {
            let id = window.location.pathname.substring(window.location.pathname.lastIndexOf('/') + 1);
            id = id.substring(0, id.length - 5);
            if (id != "index") {
                const autoScoll = function (element, root) {
                    element.scrollIntoView({
                        behavior: "smooth",
                        block: "nearest"
                    });
                };
                console.log(`articles-${id}`);
                autoScoll(document.getElementById(`article-${id}`), container);
            }
        }
        window.onbeforeunload = function () {
            window.localStorage.setItem('scrollTop', container.scrollTop);
        };
    </script>

    <link rel="stylesheet" href="../third/pace-theme-minimal.tmpl.css" cache="force">
    <link rel="stylesheet" href="../third/atom-one-dark.css" cache="force">
    <script data-pace-options='{ "ajax": false }' src="../third/pace.js" cache="force"></script>
    <script src="../third/highlight.pack.js" cache="force"></script>

    <script>
        let mdContainer = document.getElementById("md-container");
        hljs.initHighlightingOnLoad();
        for (const it of mdContainer.querySelectorAll("pre code")) {
            hljs.highlightBlock(it);
        }
        for (const pre of mdContainer.querySelectorAll("pre")) {
            let last = pre.previousElementSibling;
            if (last && last.tagName == "P" && (last.innerHTML.startsWith("+&gt; ") || last.innerHTML.startsWith("-&gt; "))) {
                let desc = document.createElement("div");
                desc.className = 'foldable';
                if (last.innerHTML.startsWith("-&gt; ")) {
                    desc.innerHTML = "▶ " + last.innerHTML.substring("-&gt; ".length);
                    pre.style.display = "none";
                } else {
                    desc.innerHTML = "▼ " + last.innerHTML.substring("+&gt; ".length);
                    pre.style.display = "";
                }
                pre.style.marginTop = "0";
                pre.style.marginBottom = "0";

                last.innerHTML = "";
                last.className += ' foldable-parent';
                last.addEventListener("click", () => {
                    if (pre.style.display == "none") {
                        desc.innerHTML = "▼ " + desc.innerHTML.substring("▶ ".length);
                        pre.style.display = "";
                    } else {
                        desc.innerHTML = "▶ " + desc.innerHTML.substring("▼ ".length);
                        pre.style.display = "none";
                    }
                });
                last.appendChild(desc);
                last.appendChild(pre);
            }
        }

        //点击查看原图
        for (const img of document.querySelectorAll("#md-container img")) {
            img.onclick = function () {
                console.log("click");
                let newDiv = document.createElement('div');
                newDiv.setAttribute("class", "img-view-bkg");

                let hitDiv = document.createElement('div');
                hitDiv.setAttribute("class", "img-view-hint");
                hitDiv.innerHTML = "双击图片或者点击空白处取消图片查看";

                let newImg = document.createElement('img');
                newImg.setAttribute("class", "img-view-img");
                newImg.src = this.src;

                let newSpan = document.createElement("div");
                newSpan.setAttribute("class", "img-view");
                newSpan.appendChild(newDiv);
                newSpan.appendChild(newImg);
                newSpan.appendChild(hitDiv);
                document.body.appendChild(newSpan);

                newImg.ondblclick = function () {
                    document.body.removeChild(newSpan);
                };

                newDiv.onclick = function () {
                    document.body.removeChild(newSpan);
                };
            };
        }

        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            chtml: {
                displayAlign: 'left'
            }
        };
        let oldOnLoad = window.onload;
        window.onload = () => {
            let spt = document.createElement("script");
            spt.setAttribute("id", "MathJax-script");
            spt.setAttribute("async", true);
            spt.setAttribute("src", "../third/tex-chtml.js");
            document.body.append(spt);

            if (oldOnLoad) {
                oldOnLoad();
            }
        };
    </script>
</body>

</html>