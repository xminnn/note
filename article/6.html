<!DOCTYPE html>
<html lang="zh" οndragstart="return false;">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>icmp实现ping</title>
    <link rel="stylesheet" href="../index.css" cache="force">
</head>

<body οndragstart="return false;">
    <div style="position: fixed; left: 0; top: 0; width: 100%; height: 100%; padding: 0;">
        <div class="left-container">
            <div class="header-container">
                <a href="https://github.com/xminnn"><img src="../icon.jpg" cache="force"></a>
            </div>
            <div id="dir-container">
                <div class="node-dir">
<div class="node-dir-name">c++</div>
<div class="node-children">
<div class="node-item">
<div id="article-1745078040871" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040871.html">代码静态检测工具</a>
</div>
</div>
<div class="node-item">
<div id="article-1" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1.html">共享内存</a>
</div>
</div>
<div class="node-item">
<div id="article-2" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./2.html">开源项目</a>
</div>
</div>
<div class="node-item">
<div id="article-3" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./3.html">开源游戏引擎以及工具</a>
</div>
</div>
<div class="node-item">
<div id="article-10" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./10.html">推荐文章</a>
</div>
</div>
<div class="node-item">
<div id="article-4" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./4.html">性能分析</a>
</div>
</div>
<div class="node-item">
<div id="article-7" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./7.html">c++基础总结</a>
</div>
</div>
<div class="node-item">
<div id="article-8" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./8.html">c++模板的偏特化与全特化</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040863" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040863.html">c++模板元编程</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040864" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040864.html">c++虚表的内存结构</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040862" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040862.html">c++右值引用</a>
</div>
</div>
<div class="node-item">
<div id="article-5" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./5.html">fopen</a>
</div>
</div>
<div class="node-item">
<div id="article-6" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./6.html">icmp实现ping</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078880027" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078880027.html">Makefile</a>
</div>
</div>
<div class="node-item">
<div id="article-9" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./9.html">mmap</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040869" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040869.html">opengl积雪效果</a>
</div>
</div>
<div class="node-item">
<div id="article-1745082315831" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745082315831.html">socket配置</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040870" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040870.html">tcp抓包</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">linux</div>
<div class="node-children">
<div class="node-item">
<div id="article-11" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./11.html">常见问题</a>
</div>
</div>
<div class="node-item">
<div id="article-12" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./12.html">常用命令</a>
</div>
</div>
<div class="node-item">
<div id="article-13" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./13.html">代理</a>
</div>
</div>
<div class="node-item">
<div id="article-21" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./21.html">镜像源</a>
</div>
</div>
<div class="node-item">
<div id="article-20" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./20.html">配置网络</a>
</div>
</div>
<div class="node-item">
<div id="article-22" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./22.html">设置core文件</a>
</div>
</div>
<div class="node-item">
<div id="article-14" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./14.html">用户与权限</a>
</div>
</div>
<div class="node-item">
<div id="article-15" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./15.html">dns修改</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040872" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040872.html">proot</a>
</div>
</div>
<div class="node-item">
<div id="article-16" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./16.html">qemu</a>
</div>
</div>
<div class="node-item">
<div id="article-17" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./17.html">ssh穿透</a>
</div>
</div>
<div class="node-item">
<div id="article-18" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./18.html">surfacebook2安装archlinux记录</a>
</div>
</div>
<div class="node-item">
<div id="article-19" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./19.html">systemctl守护自定义程序</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">服务</div>
<div class="node-children">
<div class="node-item">
<div id="article-27" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./27.html">elasticsearch</a>
</div>
</div>
<div class="node-item">
<div id="article-26" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./26.html">kafka</a>
</div>
</div>
<div class="node-item">
<div id="article-25" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./25.html">mongo</a>
</div>
</div>
<div class="node-item">
<div id="article-24" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./24.html">mysql</a>
</div>
</div>
<div class="node-item">
<div id="article-23" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./23.html">redis</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">架构</div>
<div class="node-children">
<div class="node-item">
<div id="article-1745082315832" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745082315832.html">好文推荐</a>
</div>
</div>
<div class="node-item">
<div id="article-29" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./29.html">游戏任务系统</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">算法</div>
<div class="node-children">
<div class="node-item">
<div id="article-30" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./30.html">查找算法</a>
</div>
</div>
<div class="node-item">
<div id="article-35" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./35.html">调度算法</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040877" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040877.html">动态规划</a>
</div>
</div>
<div class="node-item">
<div id="article-42" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./42.html">二叉树</a>
</div>
</div>
<div class="node-item">
<div id="article-34" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./34.html">缓存淘汰算法</a>
</div>
</div>
<div class="node-item">
<div id="article-36" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./36.html">加密算法</a>
</div>
</div>
<div class="node-item">
<div id="article-45" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./45.html">链表</a>
</div>
</div>
<div class="node-item">
<div id="article-31" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./31.html">排序算法</a>
</div>
</div>
<div class="node-item">
<div id="article-44" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./44.html">其他常见算法题</a>
</div>
</div>
<div class="node-item">
<div id="article-33" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./33.html">时间轮</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040879" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040879.html">算法思想</a>
</div>
</div>
<div class="node-item">
<div id="article-32" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./32.html">跳表</a>
</div>
</div>
<div class="node-item">
<div id="article-37" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./37.html">寻路算法</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040878" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040878.html">游戏开发中的噪声算法</a>
</div>
</div>
<div class="node-item">
<div id="article-43" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./43.html">栈和队列</a>
</div>
</div>
<div class="node-item">
<div id="article-38" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./38.html">正太分布随机数算法</a>
</div>
</div>
<div class="node-item">
<div id="article-39" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./39.html">huffman压缩算法</a>
</div>
</div>
<div class="node-item">
<div id="article-40" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./40.html">lz77压缩算法</a>
</div>
</div>
<div class="node-item">
<div id="article-41" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./41.html">md5算法</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">工具</div>
<div class="node-children">
<div class="node-item">
<div id="article-51" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./51.html">软媒工具组件精选</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040876" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040876.html">网址大全</a>
</div>
</div>
<div class="node-item">
<div id="article-49" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./49.html">ai对话</a>
</div>
</div>
<div class="node-item">
<div id="article-50" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./50.html">ai绘画</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040874" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040874.html">blender</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040875" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040875.html">docker</a>
</div>
</div>
<div class="node-item">
<div id="article-47" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./47.html">git</a>
</div>
</div>
<div class="node-item">
<div id="article-48" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./48.html">svn</a>
</div>
</div>
<div class="node-item">
<div id="article-53" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./53.html">vim</a>
</div>
</div>
<div class="node-item">
<div id="article-46" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./46.html">vscode</a>
</div>
</div>
<div class="node-item">
<div id="article-52" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./52.html">winfsp</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">其他</div>
<div class="node-children">
<div class="node-item">
<div id="article-56" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./56.html">开源协议</a>
</div>
</div>
<div class="node-item">
<div id="article-57" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./57.html">终端输出特殊代码</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040873" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040873.html">Android开发环境快速搭建</a>
</div>
</div>
<div class="node-item">
<div id="article-55" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./55.html">python简单日志工具</a>
</div>
</div>
<div class="node-item">
<div id="article-58" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./58.html">windows相关</a>
</div>
</div>
</div>
</div>

            </div>
        </div>
        <div class="right-container">
            <div id="md-container">
                <div class="title"> icmp实现ping </div>
                <div class="info">
                    <div class="create_time">创建:2023-10-27 17:43</div>
                    <div class="update_time">更新:2023-10-27 17:45</div>
                </div>
                <div class="line"></div>

                <div id="md-container-content" style="position: relative;"><blockquote>
  <p><a href="https://blog.csdn.net/FlushHip/article/details/83993826">https://blog.csdn.net/FlushHip/article/details/83993826</a></p>
</blockquote>
<pre><code class="cpp language-cpp">/**

// https://www.wlgly.net/post-84.html
// https://www.51cto.com/article/616746.html

## ICMP 报文格式

+0------7-------15---------------31
|  Type | Code  |    Checksum    |
+--------------------------------+
|          Message Body          |
|        (Variable length)       |
+--------------------------------+

## ICMP 报文格式解释

字段            长度      含义
Type            1字节     报文类型，用来标识报文，Type字段的取值和含义如下表1所示。
Code            1字节     代码，提供报文类型的进一步信息，Code字段的取值和含义如下表1所示。
Checksum        2字节     校验和，使用和IP相同的加法校验和算法，但是ICMP校验和仅覆盖ICMP报文。
Message Body    可变      字段的长度和内容，取决于消息的类型和代码，请参见下表1。


## ICMP消息类型代码

其中，最后一个字段的长度和内容，取决于消息的类型和代码。对应的列表如下：
表1 ICMP消息类型代码对应表

类型Type    代码Code   描述
0            0           回显应答（ping应答）
3            0           网络不可达
3            1           主机不可达
3            2           协议不可达
3            3           端口不可达
3            4           需要进行分片但设置不分片比特
3            5           源站选路失败
3            6           目的网络不认识
3            7           目的主机不认识
3            8           源主机被隔离（作废不用）
3            9           目的网络被强制禁止
3            10          目的主机被强制禁止
3            11          由于TOS，网络不可达
3            12          由于TOS，主机不可达
3            13          由于过滤，通信被强制禁止
3            14          主机越权
3            15          优先权中止生效
4            0           源端被关闭
5            0           对网络重定向
5            1           对主机重定向
5            2           对服务类型和网络重定向
5            3           对服务类型和主机重定向
8            0           请求回显（ping请求）
9            0           路由器通告
10            0           路由器请求告
11            0           传输期间生存时间为0
11            1           在数据报组装期间生存时间为0
12            0           坏的IP首部
12            1           缺少必须的选项
13            0           时间戳请求（作废不用）
14            0           时间戳应答（作废不用）
15            0           信息请求（作废不用）
16            0           信息应答（作废不用）
17            0           地址掩码请求
18            0           地址掩码应答

*/

#ifdef _WIN32

#include &lt;sys/time.h&gt;
#include &lt;time.h&gt;

#include &lt;winsock2.h&gt;
struct WindowsSocketLibInit {
    WindowsSocketLibInit() {
        WSADATA wsaData;
        WORD sockVersion = MAKEWORD(2, 2);
        WSAStartup(sockVersion, &amp;wsaData);
    }
    ~WindowsSocketLibInit() {
        WSACleanup();
    }
} INITSOCKETGLOBALVARIABLE;

#else

#include &lt;unistd.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;arpa/inet.h&gt;

#endif

#include &lt;string&gt;
#include &lt;limits&gt;

bool ping(std::string ip) {
    static unsigned INDEX = 0;

    struct IcmpHead {
        unsigned char type;
        unsigned char code;
        unsigned short checksum;
        unsigned short id;
        unsigned short seq;
    };

    int socketFd = socket(AF_INET, SOCK_RAW, IPPROTO_ICMP);

    int timeoutTick = 1000;
    setsockopt(socketFd, SOL_SOCKET, SO_RCVTIMEO, (char *)&amp;timeoutTick, sizeof(timeoutTick));

    sockaddr_in des = {AF_INET, htons(0)};
    des.sin_addr.s_addr = inet_addr(ip.c_str());

    char buff[sizeof(IcmpHead) + 32] = {0};
    IcmpHead *pIcmpHead = (IcmpHead *)(buff);

    unsigned short id = std::rand() % (std::numeric_limits&lt;unsigned short&gt;::max)();

    pIcmpHead-&gt;type = 8;
    pIcmpHead-&gt;code = 0;
    pIcmpHead-&gt;id = id;
    pIcmpHead-&gt;seq = INDEX++;
    memcpy(&amp;buff[sizeof(IcmpHead)], "FlushHip", sizeof("FlushHip"));
    pIcmpHead-&gt;checksum = [](unsigned short *buff, unsigned size) -&gt; unsigned short {
        unsigned long ret = 0;
        for (unsigned i = 0; i &lt; size; i += sizeof(unsigned short)) {
            ret += *buff++;
        }
        if (size &amp; 1) {
            ret += *(unsigned char *)buff;
        }
        ret = (ret &gt;&gt; 16) + (ret &amp; 0xFFFF);
        ret += ret &gt;&gt; 16;
        return (unsigned short)~ret;
    }((unsigned short *)buff, sizeof(buff));

    if (-1 == sendto(socketFd, buff, sizeof(buff), 0, (sockaddr *)&amp;des, sizeof(des))) {
        return false;
    }

    char recv[1 &lt;&lt; 10];
    int ret = recvfrom(socketFd, recv, sizeof(recv), 0, NULL, NULL);
    if (-1 == ret || ret &lt; 20 + sizeof(IcmpHead)) {
        return false;
    }

    IcmpHead *pRecv = (IcmpHead *)(recv + 20);
    return !(pRecv-&gt;type != 0 || pRecv-&gt;id != id);
}

long systemCurTime() {
    struct timeval tv;
    gettimeofday(&amp;tv, NULL);
    long time = 0;
    time += tv.tv_sec * 1000000;
    time += tv.tv_usec;
    return time;
}

int main(int argc, char const *argv[]) {
    if (argc &lt; 2) {
        printf("Error: need input ip");
        return -1;
    }
    std::string ip = argv[1];
    for (int i = 0; i &lt; 3; i++) {
        long curTime = systemCurTime();
        if (ping(ip.c_str())) {
            printf("ping %s success: %ld\n", ip.c_str(), systemCurTime() - curTime);
        } else {
            printf("ping %s failed: %ld\n", ip.c_str(), systemCurTime() - curTime);
        }
    }

    return 0;
}
</code></pre>
<p>利用ttl超时完成链路查询功能</p>
<pre><code class="cpp language-cpp">#pragma once

#include &lt;sys/time.h&gt;
#include &lt;time.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string&gt;
#include &lt;limits&gt;
#include &lt;functional&gt;

#ifdef _WIN32
#include &lt;winsock2.h&gt;
#include &lt;ws2tcpip.h&gt;
#include &lt;iphlpapi.h&gt;
#include &lt;icmpapi.h&gt;
struct WindowsSocketLibInit {
    WindowsSocketLibInit() {
        WSADATA wsaData;
        WORD sockVersion = MAKEWORD(2, 2);
        WSAStartup(sockVersion, &amp;wsaData);
    }
    ~WindowsSocketLibInit() {
        WSACleanup();
    }
} INITSOCKETGLOBALVARIABLE;
#else
#include &lt;unistd.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;arpa/inet.h&gt;
#endif

class PingUtil {
    struct IcmpHead {
        unsigned char type;
        unsigned char code;
        unsigned short checksum;
        unsigned short id;
        unsigned short seq;
    };

    static long curTime() {
        struct timeval tv;
        gettimeofday(&amp;tv, NULL);
        long time = 0;
        time += tv.tv_sec * 1000000;
        time += tv.tv_usec;
        return time;
    }

public:
    static int ping(std::string target, int ttl, bool increase, std::function&lt;void(int ttl, const std::string &amp;ip, long send_time_pass, long reci_time_pass)&gt; callback) {
        static unsigned INDEX = 0;
        int ret = 0;

        if (ttl &lt;= 0) {
            ttl = 64;
        }

        struct hostent *host = gethostbyname(target.c_str());
        if (host == nullptr) {
            printf("get host by name failed\n");
            return -1;
        }
        char ip[32] = {0};
        inet_ntop(AF_INET, host-&gt;h_addr_list[0], ip, sizeof(ip));    // IP转化为字符串


        int sockfd = socket(AF_INET, SOCK_RAW, IPPROTO_ICMP);
        int timeout_tick = 1000;
        setsockopt(sockfd, SOL_SOCKET, SO_RCVTIMEO, (char *)&amp;timeout_tick, sizeof(timeout_tick));

        sockaddr_in des = {AF_INET, htons(0)};
        des.sin_addr.s_addr = inet_addr(ip);

        int ittl = ttl - 1;
        if (increase) {    // 自增获取全链路流程
            ittl = 0;
        }

        do {
            ittl++;

            char buff[sizeof(IcmpHead) + 32] = {0};
            IcmpHead *icmp_send = (IcmpHead *)(buff);

            unsigned short id = std::rand() % (std::numeric_limits&lt;unsigned short&gt;::max)();
            icmp_send-&gt;type = 8;
            icmp_send-&gt;code = 0;
            icmp_send-&gt;id = id;
            icmp_send-&gt;seq = INDEX++;
            memcpy(&amp;buff[sizeof(IcmpHead)], "Hello", sizeof("Hello"));
            icmp_send-&gt;checksum = [](unsigned short *buff, unsigned size) -&gt; unsigned short {
                unsigned long ret = 0;
                for (unsigned i = 0; i &lt; size; i += sizeof(unsigned short)) {
                    ret += *buff++;
                }
                if (size &amp; 1) {
                    ret += *(unsigned char *)buff;
                }
                ret = (ret &gt;&gt; 16) + (ret &amp; 0xFFFF);
                ret += ret &gt;&gt; 16;
                return (unsigned short)~ret;
            }((unsigned short *)buff, sizeof(buff));

            if (-1 == setsockopt(sockfd, IPPROTO_IP, IP_MULTICAST_TTL, (char *)&amp;ittl, sizeof(ittl))) {
                ret = -2;
                break;
            }
            if (-1 == setsockopt(sockfd, IPPROTO_IP, IP_TTL, (char *)&amp;ittl, sizeof(ittl))) {
                ret = -3;
                break;
            }

            long last_time = curTime();

            if (-1 == sendto(sockfd, buff, sizeof(buff), 0, (sockaddr *)&amp;des, sizeof(des))) {
                ret = -4;
                break;
            }

            // 统计发送耗时
            long cur_time = curTime();
            long send_time_pass = cur_time - last_time;
            last_time = cur_time;

            char recv[4096] = {0};
            sockaddr_in recv_addr = {0};
            int addr_len = sizeof(recv_addr);
            int ret = recvfrom(sockfd, recv, sizeof(recv), 0, (sockaddr *)&amp;recv_addr, &amp;addr_len);

            // 统计接收耗时
            cur_time = curTime();
            long recv_time_pass = cur_time - last_time;
            std::string recv_ip = inet_ntoa(recv_addr.sin_addr);

            if (-1 == ret || ret &lt; 20 + (int)sizeof(IcmpHead)) {
                callback(ittl, recv_ip, send_time_pass, recv_time_pass);
                continue;    // 接收错误，直接跳过
            }
            IcmpHead *icmp_recv = (IcmpHead *)(recv + 20);
            if (icmp_recv-&gt;type == 11) {
                callback(ittl, recv_ip, send_time_pass, recv_time_pass);
            }
            if (icmp_recv-&gt;type == 0) {
                callback(ittl, recv_ip, send_time_pass, recv_time_pass);
                ret = 1;
                break;
            }
        } while (ittl &lt; ttl);

#ifdef _WIN32
        closesocket(sockfd);
#else
        close(sockfd);
#endif
        return ret;
    }
};
</code></pre></div>
            </div>
        </div>
    </div>

    <script>
        let scrollTop = window.localStorage.getItem('scrollTop');
        let container = document.getElementById("dir-container");
        if (scrollTop) {
            container.scrollTop = scrollTop;
        } else {
            let id = window.location.pathname.substring(window.location.pathname.lastIndexOf('/') + 1);
            id = id.substring(0, id.length - 5);
            if (id != "index") {
                const autoScoll = function (element, root) {
                    element.scrollIntoView({
                        behavior: "smooth",
                        block: "nearest"
                    });
                };
                console.log(`articles-${id}`);
                autoScoll(document.getElementById(`article-${id}`), container);
            }
        }
        window.onbeforeunload = function () {
            window.localStorage.setItem('scrollTop', container.scrollTop);
        };
    </script>

    <link rel="stylesheet" href="../third/pace-theme-minimal.tmpl.css" cache="force">
    <link rel="stylesheet" href="../third/atom-one-dark.css" cache="force">
    <script data-pace-options='{ "ajax": false }' src="../third/pace.js" cache="force"></script>
    <script src="../third/highlight.pack.js" cache="force"></script>

    <script>
        let mdContainer = document.getElementById("md-container");
        mdContainer.querySelectorAll("pre code");
        hljs.initHighlightingOnLoad();
        for (const it of mdContainer.querySelectorAll("pre code")) {
            hljs.highlightBlock(it);
        }

        //点击查看原图
        for (const img of document.querySelectorAll("#md-container img")) {
            img.onclick = function () {
                console.log("click");
                let newDiv = document.createElement('div');
                newDiv.setAttribute("class", "img-view-bkg");

                let hitDiv = document.createElement('div');
                hitDiv.setAttribute("class", "img-view-hint");
                hitDiv.innerHTML = "双击图片或者点击空白处取消图片查看";

                let newImg = document.createElement('img');
                newImg.setAttribute("class", "img-view-img");
                newImg.src = this.src;

                let newSpan = document.createElement("div");
                newSpan.setAttribute("class", "img-view");
                newSpan.appendChild(newDiv);
                newSpan.appendChild(newImg);
                newSpan.appendChild(hitDiv);
                document.body.appendChild(newSpan);

                newImg.ondblclick = function () {
                    document.body.removeChild(newSpan);
                };

                newDiv.onclick = function () {
                    document.body.removeChild(newSpan);
                };
            };
        }

        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            chtml: {
                displayAlign: 'left'
            }
        };
        let oldOnLoad = window.onload;
        window.onload = () => {
            let spt = document.createElement("script");
            spt.setAttribute("id", "MathJax-script");
            spt.setAttribute("async", true);
            spt.setAttribute("src", "../third/tex-chtml.js");
            document.body.append(spt);

            if (oldOnLoad) {
                oldOnLoad();
            }
        };
    </script>
</body>

</html>