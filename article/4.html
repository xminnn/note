<!DOCTYPE html>
<html lang="zh" οndragstart="return false;">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>性能分析</title>
    <link rel="stylesheet" href="../index.css" cache="force">
</head>

<body οndragstart="return false;">
    <div style="position: fixed; left: 0; top: 0; width: 100%; height: 100%; padding: 0;">
        <div class="left-container">
            <div class="header-container">
                <a href="https://github.com/xminnn"><img src="../icon.jpg" cache="force"></a>
            </div>
            <div id="dir-container">
                <div class="node-dir">
<div class="node-dir-name">c++</div>
<div class="node-children">
<div class="node-item">
<div id="article-1745078040871" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040871.html">代码静态检测工具</a>
</div>
</div>
<div class="node-item">
<div id="article-1" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1.html">共享内存</a>
</div>
</div>
<div class="node-item">
<div id="article-2" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./2.html">开源项目</a>
</div>
</div>
<div class="node-item">
<div id="article-3" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./3.html">开源游戏引擎以及工具</a>
</div>
</div>
<div class="node-item">
<div id="article-10" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./10.html">推荐文章</a>
</div>
</div>
<div class="node-item">
<div id="article-4" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./4.html">性能分析</a>
</div>
</div>
<div class="node-item">
<div id="article-7" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./7.html">c++基础总结</a>
</div>
</div>
<div class="node-item">
<div id="article-8" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./8.html">c++模板的偏特化与全特化</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040863" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040863.html">c++模板元编程</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040864" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040864.html">c++虚表的内存结构</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040862" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040862.html">c++右值引用</a>
</div>
</div>
<div class="node-item">
<div id="article-5" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./5.html">fopen</a>
</div>
</div>
<div class="node-item">
<div id="article-6" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./6.html">icmp实现ping</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078880027" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078880027.html">Makefile</a>
</div>
</div>
<div class="node-item">
<div id="article-9" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./9.html">mmap</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040869" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040869.html">opengl积雪效果</a>
</div>
</div>
<div class="node-item">
<div id="article-1745082315831" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745082315831.html">socket配置</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040870" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040870.html">tcp抓包</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">linux</div>
<div class="node-children">
<div class="node-item">
<div id="article-11" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./11.html">常见问题</a>
</div>
</div>
<div class="node-item">
<div id="article-12" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./12.html">常用命令</a>
</div>
</div>
<div class="node-item">
<div id="article-13" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./13.html">代理</a>
</div>
</div>
<div class="node-item">
<div id="article-21" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./21.html">镜像源</a>
</div>
</div>
<div class="node-item">
<div id="article-20" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./20.html">配置网络</a>
</div>
</div>
<div class="node-item">
<div id="article-22" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./22.html">设置core文件</a>
</div>
</div>
<div class="node-item">
<div id="article-14" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./14.html">用户与权限</a>
</div>
</div>
<div class="node-item">
<div id="article-15" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./15.html">dns修改</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040872" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040872.html">proot</a>
</div>
</div>
<div class="node-item">
<div id="article-16" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./16.html">qemu</a>
</div>
</div>
<div class="node-item">
<div id="article-17" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./17.html">ssh穿透</a>
</div>
</div>
<div class="node-item">
<div id="article-18" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./18.html">surfacebook2安装archlinux记录</a>
</div>
</div>
<div class="node-item">
<div id="article-19" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./19.html">systemctl守护自定义程序</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">服务</div>
<div class="node-children">
<div class="node-item">
<div id="article-27" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./27.html">elasticsearch</a>
</div>
</div>
<div class="node-item">
<div id="article-26" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./26.html">kafka</a>
</div>
</div>
<div class="node-item">
<div id="article-25" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./25.html">mongo</a>
</div>
</div>
<div class="node-item">
<div id="article-24" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./24.html">mysql</a>
</div>
</div>
<div class="node-item">
<div id="article-23" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./23.html">redis</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">架构</div>
<div class="node-children">
<div class="node-item">
<div id="article-1745082315832" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745082315832.html">好文推荐</a>
</div>
</div>
<div class="node-item">
<div id="article-29" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./29.html">游戏任务系统</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">算法</div>
<div class="node-children">
<div class="node-item">
<div id="article-30" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./30.html">查找算法</a>
</div>
</div>
<div class="node-item">
<div id="article-35" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./35.html">调度算法</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040877" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040877.html">动态规划</a>
</div>
</div>
<div class="node-item">
<div id="article-42" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./42.html">二叉树</a>
</div>
</div>
<div class="node-item">
<div id="article-34" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./34.html">缓存淘汰算法</a>
</div>
</div>
<div class="node-item">
<div id="article-36" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./36.html">加密算法</a>
</div>
</div>
<div class="node-item">
<div id="article-45" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./45.html">链表</a>
</div>
</div>
<div class="node-item">
<div id="article-31" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./31.html">排序算法</a>
</div>
</div>
<div class="node-item">
<div id="article-44" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./44.html">其他常见算法题</a>
</div>
</div>
<div class="node-item">
<div id="article-33" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./33.html">时间轮</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040879" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040879.html">算法思想</a>
</div>
</div>
<div class="node-item">
<div id="article-32" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./32.html">跳表</a>
</div>
</div>
<div class="node-item">
<div id="article-37" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./37.html">寻路算法</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040878" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040878.html">游戏开发中的噪声算法</a>
</div>
</div>
<div class="node-item">
<div id="article-43" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./43.html">栈和队列</a>
</div>
</div>
<div class="node-item">
<div id="article-38" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./38.html">正太分布随机数算法</a>
</div>
</div>
<div class="node-item">
<div id="article-39" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./39.html">huffman压缩算法</a>
</div>
</div>
<div class="node-item">
<div id="article-40" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./40.html">lz77压缩算法</a>
</div>
</div>
<div class="node-item">
<div id="article-41" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./41.html">md5算法</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">工具</div>
<div class="node-children">
<div class="node-item">
<div id="article-51" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./51.html">软媒工具组件精选</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040876" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040876.html">网址大全</a>
</div>
</div>
<div class="node-item">
<div id="article-49" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./49.html">ai对话</a>
</div>
</div>
<div class="node-item">
<div id="article-50" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./50.html">ai绘画</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040874" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040874.html">blender</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040875" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040875.html">docker</a>
</div>
</div>
<div class="node-item">
<div id="article-47" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./47.html">git</a>
</div>
</div>
<div class="node-item">
<div id="article-48" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./48.html">svn</a>
</div>
</div>
<div class="node-item">
<div id="article-53" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./53.html">vim</a>
</div>
</div>
<div class="node-item">
<div id="article-46" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./46.html">vscode</a>
</div>
</div>
<div class="node-item">
<div id="article-52" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./52.html">winfsp</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">其他</div>
<div class="node-children">
<div class="node-item">
<div id="article-56" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./56.html">开源协议</a>
</div>
</div>
<div class="node-item">
<div id="article-57" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./57.html">终端输出特殊代码</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040873" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040873.html">Android开发环境快速搭建</a>
</div>
</div>
<div class="node-item">
<div id="article-55" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./55.html">python简单日志工具</a>
</div>
</div>
<div class="node-item">
<div id="article-58" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./58.html">windows相关</a>
</div>
</div>
</div>
</div>

            </div>
        </div>
        <div class="right-container">
            <div id="md-container">
                <div class="title"> 性能分析 </div>
                <div class="info">
                    <div class="create_time">创建:2023-10-27 17:43</div>
                    <div class="update_time">更新:2025-04-19 21:35</div>
                </div>
                <div class="line"></div>

                <div id="md-container-content" style="position: relative;"><h2 id="perf"># perf</h2>
<pre><code class="sh language-sh">sudo apt install linux-perf
sudo perf record -F 99 -a -g -p `pidof ./app` -o perf.data -- sleep 30
git clone https://github.com/brendangregg/FlameGraph.git $HOME/FlameGraph
sudo perf script -i perf.data | $HOME/FlameGraph/stackcollapse-perf.pl | $HOME/FlameGraph/flamegraph.pl &gt; perf.svg
</code></pre>
<p>获取到的svg可以在浏览器打开，火焰图展示的是调用栈占据cpu时间列表。顶部就是正在执行的函数，宽度表示函数占据的cpu时间</p>
<h2 id="gprof"># gprof</h2>
<h4 id="1">1. 原理</h4>
<p><code>gprof</code> 是一个 GNU 工具，用于分析程序的性能。它通过在程序运行时收集函数调用信息和每个函数的执行时间，生成一个调用图和每个函数的时间统计信息，帮助开发者找出程序中的性能瓶颈。</p>
<h4 id="2">2. 使用步骤</h4>
<h5 id="1-1">步骤 1：编译程序</h5>
<p>在编译程序时，需要加上 <code>-pg</code> 选项，这个选项会在生成的可执行文件中插入一些额外的代码，用于收集性能数据。</p>
<pre><code class="bash language-bash">g++ -pg your_program.cpp -o your_program
</code></pre>
<p>这里 <code>your_program.cpp</code> 是你的 C++ 源文件，<code>your_program</code> 是生成的可执行文件。</p>
<h5 id="2-1">步骤 2：运行程序</h5>
<p>正常运行生成的可执行文件，程序运行结束后会在当前目录下生成一个名为 <code>gmon.out</code> 的文件，该文件包含了程序运行时的性能数据。</p>
<pre><code class="bash language-bash">./your_program
</code></pre>
<h5 id="3">步骤 3：分析性能数据</h5>
<p>使用 <code>gprof</code> 命令结合可执行文件和 <code>gmon.out</code> 文件进行分析。</p>
<pre><code class="bash language-bash">gprof your_program gmon.out
</code></pre>
<p>执行上述命令后，会输出详细的性能分析报告，主要包含以下两部分：</p>
<ul>
<li><strong>Flat profile</strong>：列出了每个函数的执行时间和调用次数，按照执行时间从长到短排序。例如：</li>
</ul>
<pre><code class="plaintext language-plaintext">Each sample counts as 0.01 seconds.
  %   cumulative   self              self     total
 time   seconds   seconds    calls  Ts/call  Ts/call  name
 90.00      0.90     0.90        1     0.90     0.90  longRunningFunction
 10.00      1.00     0.10        1     0.10     0.10  shortRunningFunction
</code></pre>
<p>从这个输出可以看出，<code>longRunningFunction</code> 函数占用了 90% 的执行时间，是性能瓶颈的可能所在。</p>
<ul>
<li><strong>Call graph</strong>：展示了函数之间的调用关系和每个调用的时间统计信息，帮助你理解函数之间的调用逻辑和性能影响。</li>
</ul>
<h4 id="3-1">3. 注意事项</h4>
<ul>
<li><code>-pg</code> 选项会使程序运行速度变慢，因为它需要额外的开销来收集性能数据。</li>
<li><code>gprof</code> 的统计结果是近似值，对于一些执行时间非常短的函数，统计结果可能不够准确。</li>
</ul>
<h2 id="valgrind"># valgrind</h2>
<p><a href="https://valgrind.org/docs/manual/ms-manual.html">https://valgrind.org/docs/manual/ms-manual.html</a><br />
<a href="https://github.com/KDE/massif-visualizer">https://github.com/KDE/massif-visualizer</a></p>
<pre><code class="sh language-sh">sudo apt install valgrind
valgrind --tool=massif ./app
ms_print massif.out.207697    ## 查看内存变化
</code></pre>
<p>使用Valgrind的memcheck工具来检查是否有内存泄漏，可以使用massif工具来对内存使用情况进行分析</p>
<h3 id="valgrind-1">valgrind 用于问题排查</h3>
<h4 id="1-2">1. 原理</h4>
<p><code>valgrind</code> 是一个强大的内存调试和性能分析工具集，它可以检测内存泄漏、越界访问、未初始化内存使用等内存相关问题，还可以进行 CPU 性能分析。<code>valgrind</code> 通过在程序运行时对其进行插桩，监控程序的内存操作和 CPU 指令执行情况。</p>
<h4 id="2-2">2. 常见工具及使用方法</h4>
<h5 id="memcheck">内存检查（Memcheck）</h5>
<p><code>Memcheck</code> 是 <code>valgrind</code> 最常用的工具，用于检测内存泄漏和其他内存相关错误。</p>
<pre><code class="bash language-bash">valgrind --leak-check=full --show-leak-kinds=all ./your_program
</code></pre>
<ul>
<li><code>--leak-check=full</code>：开启全面的内存泄漏检查。</li>
<li><code>--show-leak-kinds=all</code>：显示所有类型的内存泄漏信息。</li>
</ul>
<p>执行上述命令后，<code>valgrind</code> 会输出详细的内存检查报告，例如：</p>
<pre><code class="plaintext language-plaintext">==1234== HEAP SUMMARY:
==1234==     in use at exit: 1024 bytes in 1 blocks
==1234==   total heap usage: 1 allocs, 0 frees, 1024 bytes allocated
==1234== 
==1234== 1024 bytes in 1 blocks are definitely lost in loss record 1 of 1
==1234==    at 0x4C2FB0F: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==1234==    by 0x108659: main (your_program.cpp:10)
</code></pre>
<p>从这个报告可以看出，程序存在内存泄漏，在 <code>main</code> 函数的第 10 行使用 <code>malloc</code> 分配的 1024 字节内存没有被释放。</p>
<h5 id="cpucallgrind">CPU 性能分析（Callgrind）</h5>
<p><code>Callgrind</code> 用于分析程序的 CPU 性能，它可以收集函数调用信息和每个函数的指令执行次数。</p>
<pre><code class="bash language-bash">valgrind --tool=callgrind ./your_program
</code></pre>
<p>执行上述命令后，会在当前目录下生成一个名为 <code>callgrind.out.&lt;pid&gt;</code> 的文件，其中 <code>&lt;pid&gt;</code> 是程序的进程 ID。可以使用 <code>kcachegrind</code> 等工具来可视化分析这个文件：</p>
<pre><code class="bash language-bash">kcachegrind callgrind.out.&lt;pid&gt;
</code></pre>
<p><code>kcachegrind</code> 会以图形化的方式展示函数调用图和每个函数的性能统计信息，帮助你找出性能瓶颈。</p>
<h4 id="3-2">3. 注意事项</h4>
<ul>
<li><code>valgrind</code> 会显著降低程序的运行速度，因为它需要对程序进行插桩和监控。</li>
<li>对于一些复杂的程序，<code>valgrind</code> 生成的报告可能会非常庞大，需要仔细分析才能找到问题所在。</li>
</ul></div>
            </div>
        </div>
    </div>

    <script>
        let scrollTop = window.localStorage.getItem('scrollTop');
        let container = document.getElementById("dir-container");
        if (scrollTop) {
            container.scrollTop = scrollTop;
        } else {
            let id = window.location.pathname.substring(window.location.pathname.lastIndexOf('/') + 1);
            id = id.substring(0, id.length - 5);
            if (id != "index") {
                const autoScoll = function (element, root) {
                    element.scrollIntoView({
                        behavior: "smooth",
                        block: "nearest"
                    });
                };
                console.log(`articles-${id}`);
                autoScoll(document.getElementById(`article-${id}`), container);
            }
        }
        window.onbeforeunload = function () {
            window.localStorage.setItem('scrollTop', container.scrollTop);
        };
    </script>

    <link rel="stylesheet" href="../third/pace-theme-minimal.tmpl.css" cache="force">
    <link rel="stylesheet" href="../third/atom-one-dark.css" cache="force">
    <script data-pace-options='{ "ajax": false }' src="../third/pace.js" cache="force"></script>
    <script src="../third/highlight.pack.js" cache="force"></script>

    <script>
        let mdContainer = document.getElementById("md-container");
        mdContainer.querySelectorAll("pre code");
        hljs.initHighlightingOnLoad();
        for (const it of mdContainer.querySelectorAll("pre code")) {
            hljs.highlightBlock(it);
        }

        //点击查看原图
        for (const img of document.querySelectorAll("#md-container img")) {
            img.onclick = function () {
                console.log("click");
                let newDiv = document.createElement('div');
                newDiv.setAttribute("class", "img-view-bkg");

                let hitDiv = document.createElement('div');
                hitDiv.setAttribute("class", "img-view-hint");
                hitDiv.innerHTML = "双击图片或者点击空白处取消图片查看";

                let newImg = document.createElement('img');
                newImg.setAttribute("class", "img-view-img");
                newImg.src = this.src;

                let newSpan = document.createElement("div");
                newSpan.setAttribute("class", "img-view");
                newSpan.appendChild(newDiv);
                newSpan.appendChild(newImg);
                newSpan.appendChild(hitDiv);
                document.body.appendChild(newSpan);

                newImg.ondblclick = function () {
                    document.body.removeChild(newSpan);
                };

                newDiv.onclick = function () {
                    document.body.removeChild(newSpan);
                };
            };
        }

        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            chtml: {
                displayAlign: 'left'
            }
        };
        let oldOnLoad = window.onload;
        window.onload = () => {
            let spt = document.createElement("script");
            spt.setAttribute("id", "MathJax-script");
            spt.setAttribute("async", true);
            spt.setAttribute("src", "../third/tex-chtml.js");
            document.body.append(spt);

            if (oldOnLoad) {
                oldOnLoad();
            }
        };
    </script>
</body>

</html>