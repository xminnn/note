<!DOCTYPE html>
<html lang="zh" οndragstart="return false;">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mmap</title>
    <link rel="stylesheet" href="../index.css" cache="force">
</head>

<body οndragstart="return false;">
    <div style="position: fixed; left: 0; top: 0; width: 100%; height: 100%; padding: 0;">
        <div class="left-container">
            <div class="header-container">
                <a href="https://github.com/xminnn"><img src="../icon.jpg" cache="force"></a>
            </div>
            <div id="dir-container">
                <div class="node-dir">
<div class="node-dir-name">c++</div>
<div class="node-children">
<div class="node-item">
<div id="article-7" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./7.html">c++基础总结</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040862" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040862.html">c++右值引用</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040863" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040863.html">c++模板元编程</a>
</div>
</div>
<div class="node-item">
<div id="article-8" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./8.html">c++模板的偏特化与全特化</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040864" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040864.html">c++虚表的内存结构</a>
</div>
</div>
<div class="node-item">
<div id="article-1745769480197" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745769480197.html">core保证日志写入</a>
</div>
</div>
<div class="node-item">
<div id="article-5" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./5.html">fopen</a>
</div>
</div>
<div class="node-item">
<div id="article-6" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./6.html">icmp实现ping</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078880027" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078880027.html">Makefile</a>
</div>
</div>
<div class="node-item">
<div id="article-9" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./9.html">mmap</a>
</div>
</div>
<div class="node-item">
<div id="article-1745082315831" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745082315831.html">socket配置</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040871" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040871.html">代码静态检测工具</a>
</div>
</div>
<div class="node-item">
<div id="article-1" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1.html">共享内存</a>
</div>
</div>
<div class="node-item">
<div id="article-3" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./3.html">开源游戏引擎以及工具</a>
</div>
</div>
<div class="node-item">
<div id="article-2" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./2.html">开源项目</a>
</div>
</div>
<div class="node-item">
<div id="article-4" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./4.html">性能分析</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">游戏后端</div>
<div class="node-children">
<div class="node-item">
<div id="article-1745504985606" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745504985606.html">服务器消息架构</a>
</div>
</div>
<div class="node-item">
<div id="article-1745504985608" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745504985608.html">道具系统</a>
</div>
</div>
<div class="node-item">
<div id="article-1745504985607" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745504985607.html">条件系统</a>
</div>
</div>
<div class="node-item">
<div id="article-1745082315832" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745082315832.html">好文推荐</a>
</div>
</div>
<div class="node-item">
<div id="article-1745765918114" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745765918114.html">导表设计</a>
</div>
</div>
<div class="node-item">
<div id="article-1745937479784" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745937479784.html">排名系统</a>
</div>
</div>
<div class="node-item">
<div id="article-1745769496998" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745769496998.html">日志和监控系统设计</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">服务</div>
<div class="node-children">
<div class="node-item">
<div id="article-27" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./27.html">elasticsearch</a>
</div>
</div>
<div class="node-item">
<div id="article-26" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./26.html">kafka</a>
</div>
</div>
<div class="node-item">
<div id="article-25" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./25.html">mongo</a>
</div>
</div>
<div class="node-item">
<div id="article-24" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./24.html">mysql</a>
</div>
</div>
<div class="node-item">
<div id="article-23" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./23.html">redis</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">算法</div>
<div class="node-children">
<div class="node-item">
<div id="article-39" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./39.html">huffman压缩算法</a>
</div>
</div>
<div class="node-item">
<div id="article-40" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./40.html">lz77压缩算法</a>
</div>
</div>
<div class="node-item">
<div id="article-41" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./41.html">md5算法</a>
</div>
</div>
<div class="node-item">
<div id="article-42" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./42.html">二叉树</a>
</div>
</div>
<div class="node-item">
<div id="article-44" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./44.html">其他常见算法题</a>
</div>
</div>
<div class="node-item">
<div id="article-36" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./36.html">加密算法</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040877" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040877.html">动态规划</a>
</div>
</div>
<div class="node-item">
<div id="article-37" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./37.html">寻路算法</a>
</div>
</div>
<div class="node-item">
<div id="article-31" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./31.html">排序算法</a>
</div>
</div>
<div class="node-item">
<div id="article-33" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./33.html">时间轮</a>
</div>
</div>
<div class="node-item">
<div id="article-30" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./30.html">查找算法</a>
</div>
</div>
<div class="node-item">
<div id="article-43" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./43.html">栈和队列</a>
</div>
</div>
<div class="node-item">
<div id="article-38" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./38.html">正太分布随机数算法</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040878" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040878.html">游戏开发中的噪声算法</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040879" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040879.html">算法思想</a>
</div>
</div>
<div class="node-item">
<div id="article-34" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./34.html">缓存淘汰算法</a>
</div>
</div>
<div class="node-item">
<div id="article-35" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./35.html">调度算法</a>
</div>
</div>
<div class="node-item">
<div id="article-32" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./32.html">跳表</a>
</div>
</div>
<div class="node-item">
<div id="article-45" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./45.html">链表</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">linux</div>
<div class="node-children">
<div class="node-item">
<div id="article-15" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./15.html">dns修改</a>
</div>
</div>
<div class="node-item">
<div id="article-1745769480199" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745769480199.html">linux测试磁盘读写速度</a>
</div>
</div>
<div class="node-item">
<div id="article-1745769480200" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745769480200.html">linux添加swap分区</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040872" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040872.html">proot</a>
</div>
</div>
<div class="node-item">
<div id="article-16" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./16.html">qemu</a>
</div>
</div>
<div class="node-item">
<div id="article-17" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./17.html">ssh穿透</a>
</div>
</div>
<div class="node-item">
<div id="article-18" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./18.html">surfacebook2安装archlinux记录</a>
</div>
</div>
<div class="node-item">
<div id="article-19" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./19.html">systemctl守护自定义程序</a>
</div>
</div>
<div class="node-item">
<div id="article-1745505189602" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745505189602.html">tcp抓包</a>
</div>
</div>
<div class="node-item">
<div id="article-13" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./13.html">代理</a>
</div>
</div>
<div class="node-item">
<div id="article-12" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./12.html">常用命令</a>
</div>
</div>
<div class="node-item">
<div id="article-11" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./11.html">常见问题</a>
</div>
</div>
<div class="node-item">
<div id="article-14" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./14.html">用户与权限</a>
</div>
</div>
<div class="node-item">
<div id="article-22" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./22.html">设置core文件</a>
</div>
</div>
<div class="node-item">
<div id="article-20" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./20.html">配置网络</a>
</div>
</div>
<div class="node-item">
<div id="article-21" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./21.html">镜像源</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">工具</div>
<div class="node-children">
<div class="node-item">
<div id="article-49" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./49.html">ai对话</a>
</div>
</div>
<div class="node-item">
<div id="article-50" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./50.html">ai绘画</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040874" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040874.html">blender</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040875" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040875.html">docker</a>
</div>
</div>
<div class="node-item">
<div id="article-47" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./47.html">git</a>
</div>
</div>
<div class="node-item">
<div id="article-48" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./48.html">svn</a>
</div>
</div>
<div class="node-item">
<div id="article-53" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./53.html">vim</a>
</div>
</div>
<div class="node-item">
<div id="article-46" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./46.html">vscode</a>
</div>
</div>
<div class="node-item">
<div id="article-52" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./52.html">winfsp</a>
</div>
</div>
<div class="node-item">
<div id="article-1745078040876" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040876.html">网址大全</a>
</div>
</div>
<div class="node-item">
<div id="article-51" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./51.html">软媒工具组件精选</a>
</div>
</div>
</div>
</div>
<div class="node-dir">
<div class="node-dir-name">其他</div>
<div class="node-children">
<div class="node-item">
<div id="article-1745078040873" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745078040873.html">Android开发环境快速搭建</a>
</div>
</div>
<div class="node-item">
<div id="article-1745506516212" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./1745506516212.html">opengl积雪效果</a>
</div>
</div>
<div class="node-item">
<div id="article-55" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./55.html">python简单日志工具</a>
</div>
</div>
<div class="node-item">
<div id="article-58" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./58.html">windows相关</a>
</div>
</div>
<div class="node-item">
<div id="article-56" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./56.html">开源协议</a>
</div>
</div>
<div class="node-item">
<div id="article-57" class="node-one">
<div class="tab_1"></div>
<a clas="node-name" href="./57.html">终端输出特殊代码</a>
</div>
</div>
</div>
</div>

            </div>
        </div>
        <div class="right-container">
            <div id="md-container">
                <div class="title"> mmap </div>
                <div class="info">
                    <div class="create_time">创建:2023-12-06 17:06</div>
                    <div class="update_time">更新:2025-04-19 23:05</div>
                </div>
                <div class="line"></div>

                <div id="md-container-content" style="position: relative;"><p><code>mmap</code>是一种UNIX系统调用，它将一个文件或者其他对象映射进内存。通过这种方式，文件可以像访问普通内存一样被访问，而不需要像<code>read</code>或<code>write</code>这样的系统调用。这种方法有一些显著的优点，但也有一些潜在的缺点和注意事项。</p>
<h3 id="mmap">mmap的速度</h3>
<p><code>mmap</code>的速度相比传统的文件I/O操作（如<code>read</code>和<code>write</code>）有一些优势：</p>
<ol>
<li><strong>减少拷贝：</strong> <code>mmap</code>通过内存映射的方式，避免了数据在用户空间和内核空间之间的多次拷贝，因为它直接在内存中进行操作。</li>
<li><strong>页面缓存：</strong> 映射的文件可以利用操作系统的页面缓存（page cache），这意味着频繁访问的数据可以快速从缓存中获取，而不是每次都从磁盘读取。</li>
<li><strong>按需加载：</strong> <code>mmap</code>通常是惰性的，它只会在实际访问某个内存区域时才加载那部分数据到内存中，这可以节省内存，并且对于大文件而言，可以提高效率。</li>
</ol>
<h3 id="mmap-1">mmap的缺点</h3>
<p>尽管<code>mmap</code>有许多优点，但也有一些缺点：</p>
<ol>
<li><strong>文件大小限制：</strong> 对于映射的文件，其大小通常受限于虚拟内存的大小，这对于非常大的文件可能是一个问题。</li>
<li><strong>碎片化：</strong> 如果频繁地映射和解除映射小文件或不连续的文件区域，可能会导致地址空间的碎片化。</li>
<li><strong>复杂性：</strong> 使用<code>mmap</code>可能会增加程序的复杂性，因为需要处理更多与内存管理相关的问题，比如页面错误（page faults）和同步问题。</li>
<li><strong>同步问题：</strong> 对于需要写入的映射，确保数据正确同步回文件需要额外的调用（如<code>msync</code>），否则可能会丢失数据。</li>
</ol>
<h3 id="mmap-2">mmap后指针变化问题</h3>
<p>当使用<code>mmap</code>映射文件到内存之后，会得到一个指向内存中文件数据起始位置的指针。如果解除映射（通过<code>munmap</code>），然后重新映射同一个文件，可能会得到一个不同的指针。这是因为操作系统可能会将文件映射到进程的不同地址空间部分。因此，不能依赖于映射之间的指针保持不变，每次映射后都应该使用返回的新指针。</p>
<h3 id="">持久化</h3>
<p>使用 mmap 创建的内存映射通常与底层文件系统的页面缓存（page cache）相关联。这意味着，当对映射的内存区域进行写操作时，这些更改最终会反映到映射的文件上。但是，这个过程是由操作系统控制的，具体来说，是由操作系统的虚拟内存管理器和页面写回策略决定的。</p>
<p>当程序正常运行时，对映射内存的更改可能会留在内存中一段时间（在页面缓存中），并且不会立即写回到磁盘。操作系统会在适当的时候，根据需要将更改的页面写回磁盘。这个过程称为“延迟写入”（delayed write）或“惰性写入”（lazy write）。</p>
<p>如果程序崩溃，操作系统的页面缓存仍然保留了对应的更改。因为页面缓存是由操作系统管理的，所以即便是程序崩溃，操作系统仍然会在之后的某个时刻将脏页面（已修改的页面）写回到磁盘。这意味着，理论上，即使程序崩溃，通过 mmap 进行的写入也会最终被保存到磁盘。</p>
<p>然而，这里有几个注意点：</p>
<ol>
<li>同步调用： 如果想确保数据即时写入磁盘，可以在程序中使用 msync 系统调用来手动触发映射区域的同步。这对于需要数据持久性保证的应用程序来说是非常重要的。</li>
<li>系统崩溃： 如果整个系统崩溃，比如由于电源故障，那么在系统崩溃的那一刻尚未写回磁盘的更改可能会丢失。</li>
<li>文件系统的一致性： 某些类型的文件系统可能有自己的缓存机制，这可能会影响数据何时实际写入磁盘。</li>
<li>崩溃一致性： 如果的应用程序需要在崩溃后保持数据一致性，可能需要使用事务日志或其他形式的恢复机制来确保即使在崩溃后也能恢复到一个一致的状态。</li>
</ol>
<p>因此，尽管操作系统会尝试在程序崩溃后将更改写入磁盘，但依赖于这种行为来保证数据一致性和持久性通常不是一个好的做法。如果数据的完整性对的应用程序来说非常重要，应该使用适当的同步机制来确保数据在必要时被写入磁盘。</p>
<h3 id="-1">简单使用例子</h3>
<p>在Linux下，<code>mmap</code> 系统调用可以将一个文件或者其它对象映射进内存。这样，文件的内容就可以像访问普通内存一样来访问，这通常比传统的read和write系统调用更加高效。</p>
<p>以下是一个使用<code>mmap</code>的简单例子，这个例子中，我们将打开一个文件，将其映射到内存中，并将这块内存的前面几个字节写为一个字符串。然后解除映射，并关闭文件。</p>
<pre><code class="cpp language-cpp">#include &lt;iostream&gt;
#include &lt;sys/mman.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;cstring&gt;

int main() {
    const char *filepath = "/tmp/mmap_example.txt";
    const char *text = "Hello, mmap!";
    int length = strlen(text) + 1; // +1 for the null terminator

    // 打开文件
    int fd = open(filepath, O_RDWR | O_CREAT, S_IRUSR | S_IWUSR);
    if (fd == -1) {
        perror("Error opening file for writing");
        return 1;
    }

    // 调整文件大小
    if (lseek(fd, length-1, SEEK_SET) == -1) {
        close(fd);
        perror("Error calling lseek() to 'stretch' the file");
        return 1;
    }

    // 写入一个空字节，确保文件大小
    if (write(fd, "", 1) == -1) {
        close(fd);
        perror("Error writing last byte of the file");
        return 1;
    }

    // 执行映射
    void *map = mmap(0, length, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);
    if (map == MAP_FAILED) {
        close(fd);
        perror("Error mmapping the file");
        return 1;
    }

    // 写入数据到映射区域
    memcpy(map, text, length);

    // 同步映射区域到文件
    if (msync(map, length, MS_SYNC) == -1) {
        perror("Could not sync the file to disk");
    }

    // 解除映射
    if (munmap(map, length) == -1) {
        close(fd);
        perror("Error un-mmapping the file");
        return 1;
    }

    // 关闭文件
    close(fd);
    return 0;
}
</code></pre>
<p>这个程序首先打开（或创建）一个文件，然后设置其大小以适应我们想要写入的数据。接下来，它创建了一个内存映射，我们可以像使用普通内存一样对其进行读写。最后，它将数据同步回文件，解除映射，并关闭文件。</p>
<p>注意，这个例子没有做任何错误处理，除了检查系统调用是否失败。在实际应用中，应该更仔细地处理可能的错误情况。</p>
<p>还要注意，使用<code>mmap</code>时，需要确保文件的大小至少与想要映射的大小一样大。在这个例子中，我们通过写入一个空字节到文件的末尾来“拉伸”文件至所需的大小。此外，<code>open</code>调用中的<code>O_CREAT</code>标志意味着如果文件不存在，它将被创建，<code>S_IRUSR | S_IWUSR</code>设置了文件的权限，使得用户可以读写文件。</p>
<p>在执行这段代码之前，确保<code>/tmp</code>目录是存在的，并且有足够的权限在那里创建和写入文件。</p>
<h4 id="go">go版本</h4>
<pre><code class="go language-go">package main

import (
    "fmt"
    "os"
    "syscall"
    "unsafe"
)

// LargeData 定义一个大结构体
type LargeData struct {
    Field1 int32
    Field2 int64
    Field3 float64
    Field4 [10]int16
}

func main() {
    // 打开文件，如果文件不存在则创建
    file, err := os.OpenFile("large_data.bin", os.O_RDWR|os.O_CREATE, 0666)
    if err != nil {
        fmt.Println("Failed to open file:", err)
        return
    }
    defer file.Close()

    // 获取结构体的大小
    structSize := int(unsafe.Sizeof(LargeData{}))

    // 调整文件大小以匹配结构体大小
    err = file.Truncate(int64(structSize))
    if err != nil {
        fmt.Println("Failed to truncate file:", err)
        return
    }

    // 进行内存映射
    data, err := syscall.Mmap(int(file.Fd()), 0, structSize, syscall.PROT_READ|syscall.PROT_WRITE, syscall.MAP_SHARED)
    if err != nil {
        fmt.Println("Failed to mmap:", err)
        return
    }
    defer syscall.Munmap(data)

    // 将映射的内存转换为结构体指针
    largeData := (*LargeData)(unsafe.Pointer(&amp;data[0]))

    // 读取结构体字段的值
    fmt.Printf("Field1: %d, Field2: %d, Field3: %f\n", largeData.Field1, largeData.Field2, largeData.Field3)
    fmt.Printf("Field4: %v\n", largeData.Field4)

    // 修改结构体的值
    largeData.Field1 = 100
    largeData.Field2 = 200
    largeData.Field3 = 300.5
    for i := range largeData.Field4 {
        largeData.Field4[i] = int16(i)
    }

    // 同步内存映射区域到文件
    err = syscall.Msync(data, syscall.MS_SYNC)
    if err != nil {
        fmt.Println("Failed to msync:", err)
        return
    }
}
</code></pre>
<p>代码解释</p>
<ol>
<li><strong>结构体定义</strong>：定义了一个名为<code>LargeData</code>的大结构体，包含不同类型的字段，如<code>int32</code>、<code>int64</code>、<code>float64</code>和数组。</li>
<li><strong>文件操作</strong>：使用<code>os.OpenFile</code>打开文件，若文件不存在则创建。使用<code>file.Truncate</code>调整文件大小，使其与结构体大小一致。</li>
<li><strong>内存映射</strong>：使用<code>syscall.Mmap</code>将文件映射到内存中，设置为可读可写且共享模式。</li>
<li><strong>结构体映射</strong>：通过<code>unsafe.Pointer</code>将映射的内存首地址转换为<code>LargeData</code>结构体的指针，这样就可以直接通过该指针访问和修改结构体的字段。</li>
<li><strong>数据读写</strong>：可以像操作普通结构体一样读取和修改<code>largeData</code>指针指向的结构体内容。</li>
<li><strong>同步操作</strong>：使用<code>syscall.Msync</code>将内存中的修改同步到文件中。</li>
</ol>
<p>注意事项</p>
<ul>
<li><strong><code>unsafe</code>包的使用</strong>：<code>unsafe</code>包绕过了Go语言的类型系统和内存安全检查，使用时要格外小心，因为错误的使用可能会导致程序崩溃或产生难以调试的问题。</li>
<li><strong>文件大小</strong>：确保文件大小与结构体大小一致，否则可能会导致内存访问越界。</li>
<li><strong>内存对齐</strong>：不同架构下，结构体的内存对齐方式可能不同，要确保文件内容的布局和结构体的内存布局一致。</li>
<li><strong>错误处理</strong>：在文件操作、内存映射和同步过程中，要做好错误处理，保证程序的健壮性。 </li>
</ul>
<h3 id="-2">系统控制</h3>
<p>Linux 缓存管理参数<br />
在 Linux 系统中，可以通过调整以下内核参数来控制缓存的写回频率：</p>
<pre><code class="sh language-sh"># 查看当前的缓存管理参数
cat /proc/sys/vm/dirty_background_ratio  #表示脏页占总内存的比例达到多少时，内核会启动后台写回进程（pdflush）。默认值通常是 10%。
cat /proc/sys/vm/dirty_ratio #表示脏页占总内存的比例达到多少时，所有进程都会被阻塞，直到脏页被写回磁盘。默认值通常是 20%。
cat /proc/sys/vm/dirty_expire_centisecs #表示脏页在内存中可以存在的最大时间（以 1/100 秒为单位）。默认值通常是 3000（即 30 秒）。
cat /proc/sys/vm/dirty_writeback_centisecs  #表示内核每多少时间（以 1/100 秒为单位）检查一次脏页并启动写回进程。默认值通常是 500（即 5 秒）。
示例

# 调整参数（需要 root 权限）
sudo sysctl vm.dirty_background_ratio=5
sudo sysctl vm.dirty_ratio=10
sudo sysctl vm.dirty_expire_centisecs=15000
sudo sysctl vm.dirty_writeback_centisecs=1000
</code></pre></div>
            </div>
        </div>
    </div>

    <script>
        let scrollTop = window.localStorage.getItem('scrollTop');
        let container = document.getElementById("dir-container");
        if (scrollTop) {
            container.scrollTop = scrollTop;
        } else {
            let id = window.location.pathname.substring(window.location.pathname.lastIndexOf('/') + 1);
            id = id.substring(0, id.length - 5);
            if (id != "index") {
                const autoScoll = function (element, root) {
                    element.scrollIntoView({
                        behavior: "smooth",
                        block: "nearest"
                    });
                };
                console.log(`articles-${id}`);
                autoScoll(document.getElementById(`article-${id}`), container);
            }
        }
        window.onbeforeunload = function () {
            window.localStorage.setItem('scrollTop', container.scrollTop);
        };
    </script>

    <link rel="stylesheet" href="../third/pace-theme-minimal.tmpl.css" cache="force">
    <link rel="stylesheet" href="../third/atom-one-dark.css" cache="force">
    <script data-pace-options='{ "ajax": false }' src="../third/pace.js" cache="force"></script>
    <script src="../third/highlight.pack.js" cache="force"></script>

    <script>
        let mdContainer = document.getElementById("md-container");
        hljs.initHighlightingOnLoad();
        for (const it of mdContainer.querySelectorAll("pre code")) {
            hljs.highlightBlock(it);
        }
        for (const pre of mdContainer.querySelectorAll("pre")) {
            let last = pre.previousElementSibling;
            if (last && last.tagName == "P" && (last.innerHTML.startsWith("+&gt; ") || last.innerHTML.startsWith("-&gt; "))) {
                let desc = document.createElement("div");
                desc.className = 'foldable';
                if (last.innerHTML.startsWith("-&gt; ")) {
                    desc.innerHTML = "▶ " + last.innerHTML.substring("-&gt; ".length);
                    pre.style.display = "none";
                } else {
                    desc.innerHTML = "▼ " + last.innerHTML.substring("+&gt; ".length);
                    pre.style.display = "";
                }
                pre.style.marginTop = "0";
                pre.style.marginBottom = "0";

                last.innerHTML = "";
                last.className += ' foldable-parent';
                last.addEventListener("click", () => {
                    if (pre.style.display == "none") {
                        desc.innerHTML = "▼ " + desc.innerHTML.substring("▶ ".length);
                        pre.style.display = "";
                    } else {
                        desc.innerHTML = "▶ " + desc.innerHTML.substring("▼ ".length);
                        pre.style.display = "none";
                    }
                });
                last.appendChild(desc);
                last.appendChild(pre);
            }
        }

        //点击查看原图
        for (const img of document.querySelectorAll("#md-container img")) {
            img.onclick = function () {
                console.log("click");
                let newDiv = document.createElement('div');
                newDiv.setAttribute("class", "img-view-bkg");

                let hitDiv = document.createElement('div');
                hitDiv.setAttribute("class", "img-view-hint");
                hitDiv.innerHTML = "双击图片或者点击空白处取消图片查看";

                let newImg = document.createElement('img');
                newImg.setAttribute("class", "img-view-img");
                newImg.src = this.src;

                let newSpan = document.createElement("div");
                newSpan.setAttribute("class", "img-view");
                newSpan.appendChild(newDiv);
                newSpan.appendChild(newImg);
                newSpan.appendChild(hitDiv);
                document.body.appendChild(newSpan);

                newImg.ondblclick = function () {
                    document.body.removeChild(newSpan);
                };

                newDiv.onclick = function () {
                    document.body.removeChild(newSpan);
                };
            };
        }

        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            chtml: {
                displayAlign: 'left'
            }
        };
        let oldOnLoad = window.onload;
        window.onload = () => {
            let spt = document.createElement("script");
            spt.setAttribute("id", "MathJax-script");
            spt.setAttribute("async", true);
            spt.setAttribute("src", "../third/tex-chtml.js");
            document.body.append(spt);

            if (oldOnLoad) {
                oldOnLoad();
            }
        };
    </script>
</body>

</html>